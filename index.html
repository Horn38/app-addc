<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Au-del√† du Chalet</title>
<meta name="theme-color" content="#4e7260">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ADDC">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="android-launchericon-192-192.png">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  :root {
    --sage: #7a9e87;
    --sage-dark: #4e7260;
    --sage-light: #b8d4c0;
    --sage-pale: #eaf2ec;
    --mountain: #4a5568;
    --cream: #faf8f4;
    --warm: #f0ebe1;
    --text: #2d3a30;
    --text-light: #6b7c6e;
    --yes: #3a9e5f;
    --no: #e05252;
    --btn-send: #3a9e5f;
    --btn-save: #3a6b9e;
    --shadow: 0 4px 20px rgba(74,114,96,0.13);
    --radius: 14px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  body {
    font-family: 'Nunito', sans-serif;
    background: var(--cream);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* HEADER */
  .header {
    background: linear-gradient(160deg, var(--sage-dark) 0%, var(--sage) 100%);
    padding: 18px 20px 14px;
    display: flex;
    align-items: center;
    gap: 14px;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 16px rgba(78,114,96,0.25);
  }
  .header-logo {
    width: 52px;
    height: 52px;
    border-radius: 50%;
    background: white;
    padding: 4px;
    object-fit: contain;
    flex-shrink: 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  .header-title {
    color: white;
    line-height: 1.2;
  }
  .header-title .main { font-family: 'Playfair Display', serif; font-size: 1.25rem; font-weight: 600; }
  .header-title .sub { font-size: 0.72rem; letter-spacing: 0.08em; text-transform: uppercase; opacity: 0.85; font-weight: 300; }
  .back-btn {
    margin-left: auto;
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    padding: 7px 14px;
    border-radius: 20px;
    font-family: 'Nunito', sans-serif;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    display: none;
    align-items: center;
    gap: 5px;
    white-space: nowrap;
    transition: background 0.2s;
  }
  .back-btn.visible { display: flex; }
  .back-btn:active { background: rgba(255,255,255,0.35); }

  /* PAGES */
  .page { display: none; animation: fadeIn 0.28s ease; }
  .page.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }

  /* PAGE 1 - SECTEURS */
  .page-content { padding: 20px 16px; }
  .page-label {
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-light);
    margin-bottom: 14px;
    font-weight: 700;
  }
  .sector-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  .sector-card {
    background: white;
    border-radius: var(--radius);
    padding: 18px 14px;
    box-shadow: var(--shadow);
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.2s;
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  .sector-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--sage), var(--sage-light));
  }
  .sector-card:active { transform: scale(0.97); border-color: var(--sage-light); }
  .sector-icon { font-size: 1.8rem; margin-bottom: 8px; }
  .sector-name { font-weight: 700; font-size: 0.9rem; color: var(--text); }
  .sector-count { font-size: 0.72rem; color: var(--text-light); margin-top: 3px; }

  /* PAGE 2 - CHALETS */
  .chalet-list { display: flex; flex-direction: column; gap: 10px; }
  .chalet-item {
    background: white;
    border-radius: var(--radius);
    padding: 16px 18px;
    box-shadow: var(--shadow);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: all 0.2s;
    border-left: 4px solid var(--sage);
  }
  .chalet-item:active { transform: scale(0.98); background: var(--sage-pale); }
  .chalet-name { font-weight: 700; font-size: 1rem; }
  .chalet-arrow { color: var(--sage); font-size: 1.1rem; }

  /* SECTOR TITLE */
  .sector-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.4rem;
    color: var(--sage-dark);
    margin-bottom: 6px;
  }
  .sector-subtitle { color: var(--text-light); font-size: 0.82rem; margin-bottom: 18px; }

  /* PAGE 3 - CHECKLIST */
  .checklist-header {
    background: var(--warm);
    padding: 16px;
    border-bottom: 1px solid var(--sage-light);
  }
  .chalet-heading {
    font-family: 'Playfair Display', serif;
    font-size: 1.3rem;
    color: var(--sage-dark);
    margin-bottom: 12px;
  }
  .info-row { display: flex; gap: 10px; }
  .info-field {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .info-field label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-light); font-weight: 700; }
  .info-field input {
    background: white;
    border: 1.5px solid var(--sage-light);
    border-radius: 8px;
    padding: 9px 12px;
    font-family: 'Nunito', sans-serif;
    font-size: 0.9rem;
    color: var(--text);
    outline: none;
    transition: border-color 0.2s;
    width: 100%;
  }
  .info-field input:focus { border-color: var(--sage); }

  /* CHECKLIST SECTIONS */
  .checklist-body { padding: 16px; }
  .cl-section {
    margin-bottom: 20px;
    background: white;
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow);
  }
  .cl-section-title {
    background: linear-gradient(135deg, var(--sage-dark), var(--sage));
    color: white;
    padding: 11px 16px;
    font-size: 0.82rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
  }
  .cl-item {
    padding: 12px 14px;
    border-bottom: 1px solid var(--sage-pale);
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .cl-item:last-child { border-bottom: none; }
  .cl-item-top { display: flex; align-items: flex-start; justify-content: space-between; gap: 10px; }
  .cl-item-label { font-size: 0.88rem; font-weight: 600; color: var(--text); flex: 1; line-height: 1.4; }
  .cl-item-label .threshold { font-size: 0.75rem; color: var(--sage-dark); font-weight: 400; font-style: italic; display: block; margin-top: 2px; }
  .cl-checks { display: flex; gap: 8px; flex-shrink: 0; }
  .check-btn {
    width: 36px; height: 36px;
    border-radius: 50%;
    border: 2px solid #ddd;
    background: white;
    cursor: pointer;
    font-size: 1rem;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.18s;
    flex-shrink: 0;
  }
  .check-btn.yes { border-color: var(--yes); background: var(--yes); color: white; }
  .check-btn.no { border-color: var(--no); background: var(--no); color: white; }
  .check-btn:not(.yes):not(.no) { color: #ccc; }
  .qty-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding-left: 2px;
  }
  .qty-row label { font-size: 0.75rem; color: var(--text-light); font-weight: 600; white-space: nowrap; }
  .qty-input {
    width: 70px;
    border: 1.5px solid var(--sage-light);
    border-radius: 8px;
    padding: 5px 10px;
    font-family: 'Nunito', sans-serif;
    font-size: 0.88rem;
    outline: none;
    transition: border-color 0.2s;
  }
  .qty-input:focus { border-color: var(--sage); }

  /* Special items */
  .cl-item-special { background: var(--sage-pale); }
  .text-input {
    width: 100%;
    border: 1.5px solid var(--sage-light);
    border-radius: 8px;
    padding: 7px 12px;
    font-family: 'Nunito', sans-serif;
    font-size: 0.88rem;
    outline: none;
    margin-top: 4px;
  }
  .text-input:focus { border-color: var(--sage); }

  /* BUTTONS */
  .action-btns {
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding-bottom: 40px;
  }
  .btn-send, .btn-save {
    width: 100%;
    padding: 16px;
    border: none;
    border-radius: var(--radius);
    font-family: 'Nunito', sans-serif;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    letter-spacing: 0.02em;
    transition: all 0.2s;
    box-shadow: 0 4px 15px rgba(0,0,0,0.12);
  }
  .btn-send { background: var(--btn-send); color: white; }
  .btn-send:active { background: #2e8050; transform: scale(0.98); }
  .btn-save { background: var(--btn-save); color: white; }
  .btn-save:active { background: #2a5a8a; transform: scale(0.98); }

  /* TOAST */
  .toast {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--mountain);
    color: white;
    padding: 12px 24px;
    border-radius: 30px;
    font-size: 0.88rem;
    font-weight: 600;
    opacity: 0;
    transition: all 0.3s;
    z-index: 999;
    white-space: nowrap;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  .loading { opacity: 0.6; pointer-events: none; }

  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:300;display:none;align-items:center;justify-content:center;padding:16px;backdrop-filter:blur(4px);}
  .modal-overlay.open{display:flex;}
  .modal-box{background:white;border-radius:20px;width:100%;max-width:430px;max-height:88vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.3);}
  .modal-hdr{background:linear-gradient(135deg,var(--sage-dark),var(--sage));padding:16px 18px;display:flex;align-items:center;justify-content:space-between;}
  .modal-hdr h2{color:white;font-family:'Playfair Display',serif;font-size:1.05rem;}
  .modal-close-btn{background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:1rem;}
  .modal-body{overflow-y:auto;padding:18px;flex:1;}
  .pw-wrap{text-align:center;padding:16px 0;}
  .pw-wrap p{color:var(--text-light);margin-bottom:14px;font-size:0.88rem;}
  .pw-input{width:100%;padding:11px;border:2px solid var(--sage-light);border-radius:10px;font-family:'Nunito',sans-serif;font-size:1rem;outline:none;text-align:center;letter-spacing:0.1em;margin-bottom:10px;}
  .pw-input:focus{border-color:var(--sage);}
  .pw-go{background:var(--sage);color:white;border:none;padding:11px 28px;border-radius:10px;font-family:'Nunito',sans-serif;font-size:0.95rem;font-weight:700;cursor:pointer;}
  .pw-err{color:var(--no);font-size:0.8rem;margin-top:8px;display:none;}
  .adm-wrap{display:none;}
  .adm-wrap.on{display:block;}
  .adm-tabs{display:flex;gap:8px;margin-bottom:16px;}
  .adm-tab-btn{flex:1;padding:9px;border:2px solid var(--sage-light);background:white;border-radius:10px;font-family:'Nunito',sans-serif;font-size:0.82rem;font-weight:700;cursor:pointer;color:var(--text-light);}
  .adm-tab-btn.on{background:var(--sage);border-color:var(--sage);color:white;}
  .adm-pane{display:none;}
  .adm-pane.on{display:block;}
  .adm-lbl{font-size:0.7rem;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-light);font-weight:700;margin-bottom:5px;display:block;margin-top:10px;}
  .adm-inp,.adm-sel{width:100%;padding:10px 12px;border:1.5px solid var(--sage-light);border-radius:8px;font-family:'Nunito',sans-serif;font-size:0.88rem;outline:none;color:var(--text);background:white;margin-bottom:8px;}
  .adm-inp:focus,.adm-sel:focus{border-color:var(--sage);}
  .adm-add{width:100%;padding:11px;background:var(--sage);color:white;border:none;border-radius:10px;font-family:'Nunito',sans-serif;font-size:0.88rem;font-weight:700;cursor:pointer;}
  .adm-add:active{background:var(--sage-dark);}
  .adm-hr{border:none;border-top:1px solid var(--sage-light);margin:14px 0;}
  .adm-sub{font-size:0.72rem;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-light);font-weight:700;margin-bottom:8px;}
  .adm-item{display:flex;align-items:center;justify-content:space-between;padding:9px 12px;background:var(--sage-pale);border-radius:8px;margin-bottom:6px;font-size:0.88rem;font-weight:600;gap:8px;}
  .adm-del{background:none;border:none;color:var(--no);cursor:pointer;font-size:1.1rem;padding:2px 6px;}
  .emote-row{display:flex;gap:8px;align-items:center;margin-bottom:8px;}
  .emote-row .adm-inp{margin-bottom:0;flex:1;}
  .emote-box{font-size:1.3rem;width:44px;text-align:center;padding:9px;border:1.5px solid var(--sage-light);border-radius:8px;background:var(--sage-pale);flex-shrink:0;cursor:pointer;}
  .emote-box:hover{border-color:var(--sage);background:var(--sage-light);}
  .emoji-picker{display:none;flex-wrap:wrap;gap:6px;padding:10px;background:white;border:1.5px solid var(--sage-light);border-radius:12px;margin-bottom:8px;}
  .emoji-picker.open{display:flex;}
  .emoji-opt{font-size:1.4rem;padding:4px 6px;cursor:pointer;border-radius:8px;border:2px solid transparent;transition:all 0.15s;}
  .emoji-opt:hover{background:var(--sage-pale);border-color:var(--sage-light);}
  .emoji-opt.selected{background:var(--sage-pale);border-color:var(--sage);}
  .confirm-btn{background:var(--sage);color:white;border:none;padding:5px 12px;border-radius:8px;font-family:'Nunito',sans-serif;font-size:0.78rem;font-weight:700;cursor:pointer;white-space:nowrap;transition:all 0.2s;}
  .confirm-btn:active{background:var(--sage-dark);}
  .confirm-btn.saved{background:#3a9e5f;}

</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <img class="header-logo" src="data:image/png;base64,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" alt="Au-del√† du Chalet" onerror="this.style.display='none'">
  <div class="header-title">
    <div class="main">Au-del√† du Chalet</div>
    <div class="sub">Entretien ¬∑ Inspection</div>
  </div>
  <button class="back-btn" id="backBtn" onclick="goBack()">‚Üê Retour</button>
  <button class="back-btn" id="saveBtn" onclick="saveAllInventory()" style="display:none;background:rgba(59,130,246,0.85);">üíæ Sauvegarder</button>
  <button onclick="openAdmin()" style="margin-left:auto;background:rgba(255,255,255,0.18);border:1.5px solid rgba(255,255,255,0.5);color:white;padding:6px 13px;border-radius:20px;font-family:'Nunito',sans-serif;font-size:0.75rem;font-weight:700;cursor:pointer;">‚öôÔ∏è Admin</button>
</div>

<!-- PAGE 1: SECTEURS -->
<div class="page active" id="page-sectors">
  <div class="page-content">
    <div class="page-label">Choisir un secteur</div>
    <div class="sector-grid" id="sectorGrid"></div>
  </div>
</div>

<!-- PAGE 2: CHALETS -->
<div class="page" id="page-chalets">
  <div class="page-content">
    <div class="sector-title" id="sectorTitle"></div>
    <div class="sector-subtitle" id="sectorSubtitle"></div>
    <div class="chalet-list" id="chaletList"></div>
  </div>
</div>

<!-- PAGE 3: CHECKLIST -->
<div class="page" id="page-checklist">
  <div class="checklist-header">
    <div class="chalet-heading" id="chaletHeading">üè° Nom du chalet</div>
    <div class="info-row">
      <div class="info-field">
        <label>Employ√©(e)</label>
        <input type="text" id="employeeName" placeholder="Votre nom..." autocomplete="name">
      </div>
      <div class="info-field">
        <label>Date</label>
        <input type="date" id="visitDate">
      </div>
    </div>
  </div>
  <div class="checklist-body" id="checklistBody"></div>
  <div style="margin:0 16px 20px;background:white;border-radius:14px;overflow:hidden;box-shadow:0 4px 20px rgba(74,114,96,0.13);">
    <div style="background:linear-gradient(135deg,#4e7260,#7a9e87);color:white;padding:11px 16px;font-size:0.82rem;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;">üìù Notes</div>
    <div style="padding:14px;">
      <textarea id="notesField" placeholder="Observations, remarques, probl√®mes constat√©s..." style="width:100%;min-height:140px;border:1.5px solid #b8d4c0;border-radius:10px;padding:12px 14px;font-family:'Nunito',sans-serif;font-size:0.92rem;color:#2d3a30;outline:none;resize:vertical;line-height:1.6;background:#faf8f4;"></textarea>
    </div>
  </div>
  <div class="action-btns">
    <button class="btn-send" onclick="sendEmail()">
      <span>üì§</span> Envoyer par courriel
    </button>
    <button class="btn-save" onclick="savePDF()">
      <span>üíæ</span> Sauvegarder (PDF)
    </button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
let _savedSec=null,_savedIco=null;
try{_savedSec=JSON.parse(localStorage.getItem('addc_sectors'));}catch(e){}
try{_savedIco=JSON.parse(localStorage.getItem('addc_icons'));}catch(e){}
const SECTORS = _savedSec || {
  "Mandeville": ["Paradis du lac","Des pins","Sentier enchant√©","Le Zain","1510","C≈ìur du bois√©","Petit bonheur","Bravoir","L'Oasis","Verseau","260 degr√©s","B√©noline","Le Happy Goose","Castel du lac","Le H√©ro","Montagne","Or√©e du bois","Notik","Panoramique"],
  "St-Damien": ["Suyo","L'Heure Exquise","Aramis","Athos","Porthos"],
  "St-Gabriel": ["L'√âtoile du Maski","Petite Chaumi√®re"],
  "St-Barth√©l√©my": ["810","Barth√©l√©my","Le bois√©"],
  "Ste-Ursule": ["3 Petit Castor","Le Premium"],
  "St-Alexis": ["La cache des monts","Navya","R√™ve","Loup","Bois nature","Harfang","Louveteau"],
  "St-C√¥me": ["Paradis","Percen√©"],
  "St-Alphonse-de-Rodriguez": ["Z√∂r"],
  "Ste-B√©atrix": ["Villablanca"],
  "Ste-√âmilie-de-l'√ânergie": ["1404","Kabana","Utopia","Sercinia","La grange","Le Moulin","Caminho","1374","Maison Blanche"],
  "St-Jean-De-Matha": ["Lakehouse"],
  "Autres": ["Caminho chalet"]
};

let SECTOR_ICONS = _savedIco || {
  "Mandeville":"üèîÔ∏è","St-Damien":"üå≤","St-Gabriel":"‚≠ê","St-Barth√©l√©my":"üåø",
  "Ste-Ursule":"ü¶´","St-Alexis":"üê∫","St-C√¥me":"üçÇ","St-Alphonse-de-Rodriguez":"‚ú®",
  "Ste-B√©atrix":"üè°","Ste-√âmilie-de-l'√ânergie":"üíß","St-Jean-De-Matha":"üèä","Autres":"üìç"
};

// CHECKLIST DATA
// type: 'check' = oui/non, 'check-qty' = oui/non + quantit√©, 'text' = champ texte, 'info' = texte libre
const CHECKLIST = [
  {
    section: "Produits d'entretien de base",
    items: [
      { label: "Essuie-tout", threshold: "plus que 5 rouleaux", type: "check-qty" },
      { label: "Multi surface (nettoyant tout usage)", threshold: "plus que ¬Ω can", type: "check-qty" },
      { label: "Nettoyant √† plancher", threshold: "plus que ¬Ω bouteille", type: "check-qty" },
      { label: "Savon √† lessive", threshold: "plus que 1 bouteille", type: "check-qty" },
      { label: "Windex / ou √©quivalent", threshold: "plus que ¬Ω bouteille", type: "check-qty" },
      { label: "Assouplissant", threshold: "plus que 1 bouteille", type: "check-qty" },
      { label: "OxyClean en spray", threshold: "plus que ¬Ω bouteille", type: "check-qty" },
      { label: "Feuilles de Bounce", threshold: "plus que 1 bo√Æte", type: "check-qty" },
      { label: "Spray Easy-Off (nettoyage four)", threshold: "plus que 1 can", type: "check-qty" },
      { label: "Vaporisateur tissu divans Febreze", threshold: "plus que 1 bouteille", type: "check-qty" },
      { label: "Produit nettoyant pour po√™le standard et vitroc√©ramique Vim", threshold: "plus que 1 bouteille", type: "check-qty" },
      { label: "Boules de s√©chage", type: "check" },
    ]
  },
  {
    section: "Mat√©riels et produits locataires (Au-del√† du Chalet)",
    items: [
      { label: "Papier toilette", threshold: "plus que 10", type: "check-qty" },
      { label: "Savon √† main liquide", threshold: "plus que 1", type: "check-qty" },
      { label: "Savon √† vaisselle", threshold: "plus que 1", type: "check-qty" },
      { label: "√âponges √† vaisselle ‚Äì recharge", threshold: "plus que 6", type: "check-qty" },
      { label: "Linges √† vaisselle", threshold: "plus que 6", type: "check-qty" },
      { label: "Pastilles lave-vaisselle", threshold: "plus que 1 paquet", type: "check-qty" },
      { label: "D√©sodorisant Febreze", threshold: "plus que 2 en r√©serve", type: "check-qty" },
      { label: "Mouchoirs", threshold: "plus que 6", type: "check-qty" },
      { label: "Lavette carr√©e pour locataires (√† nettoyer)", threshold: "plus que 4", type: "check-qty" },
      { label: "T√™te de moppe Vida", threshold: "plus que 2", type: "check-qty" },
      { label: "Tapis noir r√©utilisable pour grille four", type: "check" },
    ]
  },
  {
    section: "Literie",
    items: [
      { label: "Taie d'oreiller, draps et housse de couette", threshold: "en double au minimum / lit", type: "check-qty" },
      { label: "Tapis de bain + serviettes √† mains / salle de bain", threshold: "2 tapis + 2 serviettes / SDB", type: "check-qty" },
      { label: "Serviette/drap de bain, d√©barbouillette", threshold: "2 √ó le nombre de locataires", type: "check-qty" },
    ]
  },
  {
    section: "Mat√©riel d'entretien (accessible aux locataires)",
    items: [
      { label: "Aspirateur", type: "check" },
      { label: "Vadrouille et seau avec tordeur", threshold: "au moins 2 t√™tes", type: "check-qty" },
      { label: "Balai / porte-poussi√®re", type: "check" },
      { label: "Petite brosse et pelle", type: "check" },
      { label: "Seau √† cendre", type: "check" },
      { label: "Sous-plat", type: "check" },
      { label: "Mitaine four", type: "check" },
      { label: "Pi√®ge √† fourmis", type: "check" },
      { label: "Pi√®ges √† souris", type: "check" },
    ]
  },
  {
    section: "Produits spa",
    items: [
      { label: "Oxy (OxyChlore)", type: "check-qty" },
      { label: "Chlore", type: "check-qty" },
      { label: "Puri spa", type: "check-qty" },
      { label: "Anti-mousse", type: "check-qty" },
      { label: "pH+", type: "check-qty" },
      { label: "pH-", type: "check-qty" },
      { label: "Alka+", type: "check-qty" },
      { label: "Alka-", type: "check-qty" },
      { label: "Anti Tarte", type: "check-qty" },
      { label: "Metal-out", type: "check-qty" },
      { label: "3 en 1 Mauve", type: "check-qty" },
      { label: "Sensation Confort", type: "check-qty" },
      { label: "Pastille Clarifiant", type: "check-qty" },
      { label: "Phos", type: "check-qty" },
      { label: "Calcium", type: "check-qty" },
      { label: "Bandelette Spa", type: "check-qty" },
      { label: "Nettoyant Filtre", type: "check-qty" },
      { label: "Spa-Vac", type: "check" },
      { label: "Filet-Spa", type: "check" },
      { label: "Filtre", type: "check-qty-serial" },
    ]
  },
  {
    section: "Produits sp√©cifiques selon les caract√©ristiques du chalet",
    items: [
      { label: "Produit nettoyant stainless en spray (si surface inox)", threshold: "plus que ¬Ω bouteille", type: "check-qty" },
      { label: "CLR en bidon (si eau ferreuse ‚Äì toilettes et douches)", type: "check-qty" },
      { label: "Plat alu pour gras BBQ au four", type: "check-qty" },
      { label: "Brosse √† BBQ", type: "check" },
      { label: "Propane Bonbonne 1", type: "check-bonbonne" },
      { label: "Propane Bonbonne 2", type: "check-bonbonne" },
      { label: "Propane Bonbonne 3", type: "check-bonbonne" },
    ]
  },
  {
    section: "Bois / Chauffage",
    items: [
      { label: "Bois int√©rieur", type: "check" },
      { label: "Bois ext√©rieur", type: "check" },
      { label: "Allume-feu", type: "check" },
      { label: "Papier journal / Petits bois d'allumage", type: "check" },
    ]
  },
  {
    section: "√âpicerie de base (condiments / essentiels)",
    items: [
      { label: "Vinaigre", type: "check" },
      { label: "Sel", type: "check" },
      { label: "Poivre", type: "check" },
      { label: "Huile", type: "check" },
      { label: "Caf√©", type: "check" },
      { label: "Filtre caf√©", type: "check" },
      { label: "Sucre", type: "check" },
      { label: "Papeterie alu", type: "check" },
      { label: "Papeterie Saran (pellicule alimentaire)", type: "check" },
      { label: "Rouleaux collants (poils)", threshold: "plus que 2", type: "check-qty" },
      { label: "√âponge magique (pour SDB)", threshold: "plus que 2", type: "check-qty" },
      { label: "Sacs √† poubelle grand cuisine", threshold: "plus que 1 rouleau", type: "check-qty" },
      { label: "Sacs √† recyclage", threshold: "plus que 1 paquet", type: "check-qty" },
      { label: "Sacs poubelle petit (pour SDB)", threshold: "plus que 2", type: "check-qty" },
      { label: "Petite vache", type: "check" },
    ]
  }
];

let currentSector = null;
let currentChalet = null;
let itemData = {};

// ---- INIT ----
function init() {
  // Set today's date
  document.getElementById('visitDate').value = new Date().toISOString().split('T')[0];
  renderSectors();
}

function renderSectors() {
  const grid = document.getElementById('sectorGrid');
  grid.innerHTML = '';
  Object.entries(SECTORS).forEach(([name, chalets]) => {
    const card = document.createElement('div');
    card.className = 'sector-card';
    card.innerHTML = `<div class="sector-icon">${SECTOR_ICONS[name] || 'üè°'}</div>
      <div class="sector-name">${name}</div>
      <div class="sector-count">${chalets.length} chalet${chalets.length > 1 ? 's' : ''}</div>`;
    card.onclick = () => showChalets(name);
    grid.appendChild(card);
  });
}

function showChalets(sector) {
  currentSector = sector;
  document.getElementById('sectorTitle').textContent = SECTOR_ICONS[sector] + ' ' + sector;
  document.getElementById('sectorSubtitle').textContent = SECTORS[sector].length + ' chalet(s) dans ce secteur';
  const list = document.getElementById('chaletList');
  list.innerHTML = '';
  SECTORS[sector].forEach(name => {
    const item = document.createElement('div');
    item.className = 'chalet-item';
    item.innerHTML = `<div class="chalet-name">${name}</div><div class="chalet-arrow">‚Ä∫</div>`;
    item.onclick = () => showChecklist(name);
    list.appendChild(item);
  });
  showPage('page-chalets');
}

async function showChecklist(chalet) {
  currentChalet = chalet;
  itemData = {};
  inventorySaved = false;
  document.getElementById('chaletHeading').textContent = 'üè° ' + chalet;
  document.getElementById('visitDate').value = new Date().toISOString().split('T')[0];
  renderChecklist();
  showPage('page-checklist');
  // Charger l'inventaire du serveur
  try {
    const r = await fetch(API_URL + '?t=' + Date.now());
    const d = await r.json();
    const inv = d.inventory && d.inventory[chalet];
    if(inv) {
      Object.keys(inv).forEach(id => {
        if(itemData[id]) {
          if(inv[id].qty) {
            itemData[id].qty = inv[id].qty;
            const q = document.getElementById('q_' + id);
            if(q) q.value = inv[id].qty;
          }
          if(inv[id].note) {
            itemData[id].note = inv[id].note;
            const s = document.getElementById('s_' + id);
            if(s) s.value = inv[id].note;
          }
          if(inv[id].yes) {
            itemData[id].yes = true;
            const yb = document.getElementById('y_' + id);
            if(yb) yb.className = 'check-btn yes';
          }
          if(inv[id].no) {
            itemData[id].no = true;
            const nb = document.getElementById('n_' + id);
            if(nb) nb.className = 'check-btn no';
          }
        }
      });
    }
  } catch(e) { /* offline */ }
}

function renderChecklist() {
  const body = document.getElementById('checklistBody');
  body.innerHTML = '';
  CHECKLIST.forEach((section, si) => {
    const sec = document.createElement('div');
    sec.className = 'cl-section';
    sec.innerHTML = `<div class="cl-section-title">${section.section}</div>`;
    section.items.forEach((item, ii) => {
      const id = `${si}_${ii}`;
      itemData[id] = { label: item.label, threshold: item.threshold || null, yes: false, no: false, qty: '', note: '' };
      const div = document.createElement('div');
      div.className = 'cl-item' + (item.type === 'check-bonbonne' ? ' cl-item-special' : '');
      if (item.type === 'check-bonbonne') {
        div.innerHTML = `
          <div class="cl-item-top">
            <div class="cl-item-label">${item.label}</div>
          </div>
          <div class="qty-row">
            <label>% restant :</label>
            <input class="qty-input" type="number" min="0" max="100" placeholder="%" id="q_${id}" oninput="itemData['${id}'].qty=this.value">
            
          </div>`;
      } else if (item.type === 'check-qty-serial') {
        div.innerHTML = `
          <div class="cl-item-top">
            <div class="cl-item-label">${item.label}</div>
          </div>
          <div class="qty-row">
            <label>Qt√© :</label>
            <input class="qty-input" type="text" placeholder="quantit√©..." id="q_${id}" oninput="itemData['${id}'].qty=this.value">
            
          </div>
          <div class="qty-row">
            <label># S√©rie :</label>
            <input class="text-input" type="text" placeholder="num√©ro de s√©rie..." id="s_${id}" oninput="itemData['${id}'].note=this.value" style="flex:1">
            
          </div>`;
      } else if (item.type === 'check-qty') {
        div.innerHTML = `
          <div class="cl-item-top">
            <div class="cl-item-label">${item.label}${item.threshold ? `<span class="threshold">‚Üí ${item.threshold}</span>` : ''}</div>
          </div>
          <div class="qty-row">
            <label>Qt√© :</label>
            <input class="qty-input" type="text" placeholder="quantit√©..." id="q_${id}" oninput="itemData['${id}'].qty=this.value">
            
          </div>`;
      } else {
        div.innerHTML = `
          <div class="cl-item-top">
            <div class="cl-item-label">${item.label}${item.threshold ? `<span class="threshold">‚Üí ${item.threshold}</span>` : ''}</div>
            <div class="cl-checks">
              <button class="check-btn" id="y_${id}" onclick="toggle('${id}','yes')">‚úì</button>
              <button class="check-btn" id="n_${id}" onclick="toggle('${id}','no')">‚úó</button>
            </div>
          </div>`;
      }
      sec.appendChild(div);
    });
    body.appendChild(sec);
  });
}

function toggle(id, which) {
  const d = itemData[id];
  if (which === 'yes') {
    d.yes = !d.yes;
    if (d.yes) d.no = false;
  } else {
    d.no = !d.no;
    if (d.no) d.yes = false;
  }
  const yb = document.getElementById('y_' + id);
  const nb = document.getElementById('n_' + id);
  yb.className = 'check-btn' + (d.yes ? ' yes' : '');
  nb.className = 'check-btn' + (d.no ? ' no' : '');
}

function showPage(pageId) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(pageId).classList.add('active');
  const isChecklist = pageId === 'page-checklist';
  const isChalets = pageId === 'page-chalets';
  const btn = document.getElementById('backBtn');
  const saveBtn = document.getElementById('saveBtn');
  if (isChecklist || isChalets) {
    btn.classList.add('visible');
  } else {
    btn.classList.remove('visible');
  }
  saveBtn.style.display = isChecklist ? 'flex' : 'none';
  window.scrollTo(0, 0);
}

let inventorySaved = false;

function hasUnsavedInventory() {
  return Object.values(itemData).some(d => d.qty || d.note);
}

function goBack() {
  const checklist = document.getElementById('page-checklist');
  if (checklist.classList.contains('active')) {
    if (!inventorySaved && hasUnsavedInventory()) {
      // Popup custom avec option sauvegarder
      const choice = confirm('‚ö†Ô∏è Vous avez des quantit√©s non sauvegard√©es.\n\nAppuyez sur OK pour sauvegarder et quitter.\nAppuyez sur Annuler pour rester sur la page.');
      if (choice) {
        saveAllInventory(true);
      }
      return;
    }
    inventorySaved = false;
    showPage('page-chalets');
  } else {
    showPage('page-sectors');
  }
}

function showToast(msg, duration = 3000) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), duration);
}

// ---- PDF GENERATION ----
function buildPDFContent(doc) {
  const { jsPDF } = window.jspdf;
  const employeeName = document.getElementById('employeeName').value || '‚Äî';
  const visitDate = document.getElementById('visitDate').value || new Date().toISOString().split('T')[0];
  const dateFormatted = visitDate.split('-').reverse().join('/');

  let y = 15;
  const pageW = doc.internal.pageSize.getWidth();
  const margin = 14;
  const colW = pageW - margin * 2;

  // Header
  doc.setFillColor(78, 114, 96);
  doc.rect(0, 0, pageW, 38, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(16);
  doc.setFont('helvetica', 'bold');
  doc.text('Au-del√† du Chalet', margin, 14);
  doc.setFontSize(10);
  doc.setFont('helvetica', 'normal');
  doc.text('Liste de v√©rification ¬∑ Entretien', margin, 22);
  
  // Chalet name
  doc.setFontSize(13);
  doc.setFont('helvetica', 'bold');
  doc.text(currentChalet || '', margin, 33);

  y = 46;
  doc.setTextColor(50, 70, 50);
  doc.setFontSize(9);
  doc.setFont('helvetica', 'normal');
  doc.text(`Employ√©(e) : ${employeeName}     Date : ${dateFormatted}`, margin, y);
  y += 8;

  // Sections
  CHECKLIST.forEach((section, si) => {
    // Check if new page needed
    if (y > 270) { doc.addPage(); y = 15; }

    // Section header
    doc.setFillColor(78, 114, 96);
    doc.roundedRect(margin, y, colW, 7, 1, 1, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(8);
    doc.setFont('helvetica', 'bold');
    doc.text(section.section.toUpperCase(), margin + 3, y + 5);
    y += 10;

    section.items.forEach((item, ii) => {
      if (y > 275) { doc.addPage(); y = 15; }
      const id = `${si}_${ii}`;
      const d = itemData[id] || {};
      const statusY = d.yes ? '‚úì' : (d.no ? '‚úó' : '‚óã');
      const statusC = d.yes ? [58, 158, 95] : (d.no ? [224, 82, 82] : [180, 180, 180]);

      // Alternating row
      if (ii % 2 === 0) {
        doc.setFillColor(234, 242, 236);
        doc.rect(margin, y - 1, colW, 6.5, 'F');
      }

      doc.setFont('helvetica', 'normal');
      doc.setFontSize(8);
      doc.setTextColor(50, 60, 50);
      const labelLines = doc.splitTextToSize(item.label, colW - 30);
      doc.text(labelLines, margin + 2, y + 4);

      // Status circle
      doc.setFillColor(...statusC);
      doc.circle(margin + colW - 5, y + 3, 2.5, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(7);
      doc.text(statusY, margin + colW - 6.3, y + 4.5);

      let rowH = Math.max(6.5, labelLines.length * 4.5);

      if (item.threshold) {
        doc.setTextColor(100, 140, 110);
        doc.setFontSize(7);
        doc.text(`‚Üí ${item.threshold}`, margin + 2, y + rowH);
        rowH += 4;
      }
      if ((item.type === 'check-qty' || item.type === 'check-bonbonne') && d.qty) {
        doc.setTextColor(70, 90, 70);
        doc.setFontSize(7);
        doc.text(`Qt√© : ${d.qty}${item.type === 'check-bonbonne' ? '%' : ''}`, margin + 2, y + rowH);
        rowH += 4;
      }

      y += rowH + 1;
    });
    y += 4;
  });

  // Notes
  const notesVal = document.getElementById('notesField') ? document.getElementById('notesField').value.trim() : '';
  if(notesVal){
    if(y > 240){ doc.addPage(); y = 15; }
    doc.setFillColor(78,114,96);
    doc.roundedRect(margin, y, colW, 7, 1, 1, 'F');
    doc.setTextColor(255,255,255);
    doc.setFontSize(8);
    doc.setFont('helvetica','bold');
    doc.text('NOTES', margin+3, y+5);
    y += 10;
    doc.setTextColor(50,60,50);
    doc.setFont('helvetica','normal');
    doc.setFontSize(8.5);
    const noteLines = doc.splitTextToSize(notesVal, colW-4);
    noteLines.forEach(line => {
      if(y > 278){ doc.addPage(); y = 15; }
      doc.text(line, margin+2, y);
      y += 5;
    });
    y += 4;
  }

  // Footer
  const totalPages = doc.internal.getNumberOfPages();
  for (let i = 1; i <= totalPages; i++) {
    doc.setPage(i);
    doc.setFontSize(7);
    doc.setTextColor(150, 160, 150);
    doc.text(`Au-del√† du Chalet ¬∑ ${currentChalet} ¬∑ ${dateFormatted} ¬∑ Page ${i}/${totalPages}`, margin, 292);
  }
}

async function generatePDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
  buildPDFContent(doc);
  return doc;
}

async function savePDF() {
  try {
    showToast('‚è≥ G√©n√©ration du PDF...');
    const doc = await generatePDF();
    const filename = `checklist_${(currentChalet || 'chalet').replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(filename);
    showToast('‚úÖ PDF sauvegard√© avec succ√®s !');
  } catch(e) {
    showToast('‚ùå Erreur lors de la g√©n√©ration PDF');
    console.error(e);
  }
}

async function sendEmail() {
  const employeeName = document.getElementById('employeeName').value;
  if (!employeeName.trim()) {
    showToast('‚ö†Ô∏è Veuillez entrer le nom de l\'employ√©(e)');
    document.getElementById('employeeName').focus();
    return;
  }
  try {
    showToast('‚è≥ Pr√©paration du courriel...');
    const doc = await generatePDF();
    const pdfData = doc.output('datauristring');
    const dateStr = document.getElementById('visitDate').value || new Date().toISOString().split('T')[0];
    const dateFormatted = dateStr.split('-').reverse().join('/');
    
    // Build email body text
    let body = `Bonjour,\n\nVeuillez trouver ci-joint la liste de v√©rification pour le chalet "${currentChalet}" (secteur : ${currentSector}).\n\nEmploy√©(e) : ${employeeName}\nDate : ${dateFormatted}\n\n--- R√âSUM√â ---\n`;
    
    CHECKLIST.forEach((section, si) => {
      body += `\n${section.section}:\n`;
      section.items.forEach((item, ii) => {
        const id = `${si}_${ii}`;
        const d = itemData[id] || {};
        const status = d.yes ? 'OUI ‚úì' : (d.no ? 'NON ‚úó' : 'N/A');
        body += `  ‚Ä¢ ${item.label}: ${status}`;
        if (d.qty) body += ` (Qt√©: ${d.qty})`;
        body += '\n';
      });
    });
    
    const notesEmailVal = document.getElementById('notesField') ? document.getElementById('notesField').value.trim() : '';
    if(notesEmailVal){ body += `\n\n--- NOTES ---\n${notesEmailVal}`; }
    body += `\n---\nEnvoy√© depuis l'app Au-del√† du Chalet`;
    
    const subject = encodeURIComponent(`Checklist ${currentChalet} ‚Äì ${dateFormatted} ‚Äì ${employeeName}`);
    const bodyEncoded = encodeURIComponent(body);
    
    // Open mail client with mailto
    window.location.href = `mailto:admin@audeladuchalet.ca?subject=${subject}&body=${bodyEncoded}`;
    
    // Also trigger download of PDF so they can attach it
    setTimeout(() => {
      doc.save(`checklist_${(currentChalet || 'chalet').replace(/\s+/g, '_')}_${dateStr}.pdf`);
      showToast('üìé PDF g√©n√©r√© ‚Äì Joignez-le √† votre courriel !', 5000);
    }, 500);
    
  } catch(e) {
    showToast('‚ùå Erreur lors de l\'envoi');
    console.error(e);
  }
}


// ===== ADMIN =====
const ADMIN_PW = "addc123";
let admUnlocked = false;

function openAdmin(){
  document.getElementById('admModal').classList.add('open');
  document.getElementById('pwInput').value='';
  document.getElementById('pwErr').style.display='none';
  if(admUnlocked){
    document.getElementById('pwWrap').style.display='none';
    document.getElementById('admWrap').classList.add('on');
  } else {
    document.getElementById('pwWrap').style.display='block';
    document.getElementById('admWrap').classList.remove('on');
  }
}
function closeAdmin(){ document.getElementById('admModal').classList.remove('open'); }
document.addEventListener('click', e=>{ if(e.target.id==='admModal') closeAdmin(); });

function checkPw(){
  if(document.getElementById('pwInput').value === ADMIN_PW){
    admUnlocked = true;
    document.getElementById('pwWrap').style.display='none';
    document.getElementById('admWrap').classList.add('on');
    admPopulateSec(); admRenderChalets(); admRenderSectors();
  } else {
    document.getElementById('pwErr').style.display='block';
    document.getElementById('pwInput').value='';
  }
}

function admSwitch(name, btn){
  document.querySelectorAll('.adm-tab-btn').forEach(b=>b.classList.remove('on'));
  document.querySelectorAll('.adm-pane').forEach(p=>p.classList.remove('on'));
  btn.classList.add('on');
  document.getElementById('admp-'+name).classList.add('on');
}

function admPopulateSec(){
  const sel = document.getElementById('admSelSec');
  sel.innerHTML = Object.keys(SECTORS).map(s=>`<option value="${s}">${s}</option>`).join('');
}

function admRenderChalets(){
  const s = document.getElementById('admSelSec').value;
  const list = document.getElementById('admChaletList');
  if(!s||!SECTORS[s]){list.innerHTML='';return;}
  list.innerHTML = SECTORS[s].map((c,i)=>
    `<div class="adm-item"><span>${c}</span><button class="adm-del" onclick="admDelChalet('${s.replace(/'/g,"\\'")}',${i})">üóëÔ∏è</button></div>`
  ).join('');
}

function admAddChalet(){
  const s = document.getElementById('admSelSec').value;
  const n = document.getElementById('admNewChalet').value.trim();
  if(!n){showToast('‚ö†Ô∏è Entrez un nom de chalet');return;}
  if(!SECTORS[s]) SECTORS[s]=[];
  SECTORS[s].push(n);
  admSave(); document.getElementById('admNewChalet').value='';
  admRenderChalets(); renderSectors();
  showToast('‚úÖ Chalet ajout√© : '+n);
}

function admDelChalet(s,i){
  const n=SECTORS[s][i];
  SECTORS[s].splice(i,1);
  admSave(); admRenderChalets(); renderSectors();
  showToast('üóëÔ∏è '+n+' supprim√©');
}

function admRenderSectors(){
  document.getElementById('admSecList').innerHTML = Object.entries(SECTORS).map(([s,ch])=>
    `<div class="adm-item"><span>${SECTOR_ICONS[s]||'üè°'} ${s} <span style="color:var(--text-light);font-weight:400;">(${ch.length})</span></span><button class="adm-del" onclick="admDelSector('${s.replace(/'/g,"\\'")}')">üóëÔ∏è</button></div>`
  ).join('');
}

const EMOJI_LIST = ['üè°','üèîÔ∏è','üå≤','‚≠ê','üåø','ü¶´','üê∫','üçÇ','‚ú®','üíß','üèä','üìç','üèïÔ∏è','üåä','‚ùÑÔ∏è','‚òÄÔ∏è','üå∏','üçÅ','üèûÔ∏è','‚õ∞Ô∏è','üåô','üî•','ü¶Ö','üêª','üå∫','üéø','‚õ∑Ô∏è','üö§','üåæ','üõñ'];
let selectedEmoji = 'üè°';

function initEmojiPicker(){
  const picker = document.getElementById('emojiPicker');
  picker.innerHTML = EMOJI_LIST.map(e =>
    `<span class="emoji-opt${e===selectedEmoji?' selected':''}" onclick="selectEmoji('${e}')">${e}</span>`
  ).join('');
}

function toggleEmojiPicker(){
  const picker = document.getElementById('emojiPicker');
  picker.classList.toggle('open');
  if(picker.classList.contains('open')) initEmojiPicker();
}

function selectEmoji(e){
  selectedEmoji = e;
  document.getElementById('emotePrev').textContent = e;
  document.querySelectorAll('.emoji-opt').forEach(el => el.classList.toggle('selected', el.textContent === e));
  document.getElementById('emojiPicker').classList.remove('open');
}

function admAddSector(){
  const n=document.getElementById('admNewSec').value.trim();
  if(!n){showToast('‚ö†Ô∏è Entrez un nom de secteur');return;}
  if(SECTORS[n]){showToast('‚ö†Ô∏è Ce secteur existe d√©j√†');return;}
  SECTORS[n]=[]; SECTOR_ICONS[n]=selectedEmoji;
  admSave(); document.getElementById('admNewSec').value=''; 
  document.getElementById('emotePrev').textContent='üè°'; selectedEmoji='üè°';
  admPopulateSec(); admRenderSectors(); renderSectors();
  showToast('‚úÖ Secteur ajout√© : '+selectedEmoji+' '+n);
}

function admDelSector(s){
  if(!confirm('Supprimer le secteur "'+s+'" et tous ses chalets ?')) return;
  delete SECTORS[s]; delete SECTOR_ICONS[s];
  admSave(); admPopulateSec(); admRenderChalets(); admRenderSectors(); renderSectors();
  showToast('üóëÔ∏è Secteur "'+s+'" supprim√©');
}

async function saveAllInventory(thenGoBack = false) {
  const btn = document.getElementById('saveBtn');
  btn.style.background = 'rgba(59,130,246,0.85)';
  btn.textContent = '‚è≥ Sauvegarde...';
  try {
    const r = await fetch(API_URL + '?t=' + Date.now());
    const d = await r.json();
    const inventory = d.inventory || {};
    if(!inventory[currentChalet]) inventory[currentChalet] = {};
    Object.keys(itemData).forEach(id => {
      const item = itemData[id];
      if(!inventory[currentChalet][id]) inventory[currentChalet][id] = {};
      inventory[currentChalet][id].qty = item.qty || '';
      inventory[currentChalet][id].note = item.note || '';
      inventory[currentChalet][id].yes = item.yes || false;
      inventory[currentChalet][id].no = item.no || false;
    });
    await fetch(API_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({sectors: d.sectors || SECTORS, icons: d.icons || SECTOR_ICONS, inventory})
    });
    inventorySaved = true;
    btn.textContent = '‚úÖ Sauvegard√©';
    showToast('‚òÅÔ∏è Inventaire sauvegard√© sur le serveur !');
    setTimeout(() => { btn.textContent = 'üíæ Sauvegarder'; }, 2000);
    if(thenGoBack) { setTimeout(() => { inventorySaved = false; showPage('page-chalets'); }, 500); }
  } catch(e) {
    btn.textContent = 'üíæ Sauvegarder';
    showToast('‚ö†Ô∏è Erreur de sauvegarde');
  }
}

const API_URL = 'https://addc.smddesign.ca/addc/api.php';

function admSave(){
  localStorage.setItem('addc_sectors', JSON.stringify(SECTORS));
  localStorage.setItem('addc_icons', JSON.stringify(SECTOR_ICONS));
  fetch(API_URL + '?t=' + Date.now()).then(r=>r.json()).then(d => {
    return fetch(API_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({sectors: SECTORS, icons: SECTOR_ICONS, inventory: d.inventory || {}})
    });
  }).then(r => r.json()).then(d => {
    if(d.status === 'ok') showToast('‚òÅÔ∏è Synchronis√© avec le serveur');
  }).catch(() => showToast('‚ö†Ô∏è Sauvegard√© localement seulement'));
}

async function syncFromServer(){
  try {
    const r = await fetch(API_URL + '?t=' + Date.now());
    const d = await r.json();
    if(d.sectors && Object.keys(d.sectors).length > 0){
      Object.keys(SECTORS).forEach(k => delete SECTORS[k]);
      Object.keys(SECTOR_ICONS).forEach(k => delete SECTOR_ICONS[k]);
      Object.assign(SECTORS, d.sectors);
      Object.assign(SECTOR_ICONS, d.icons || {});
      localStorage.setItem('addc_sectors', JSON.stringify(SECTORS));
      localStorage.setItem('addc_icons', JSON.stringify(SECTOR_ICONS));
      renderSectors();
    }
  } catch(e) { /* offline - utilise donn√©es locales */ }
}

syncFromServer();
init();
</script>

<div class="modal-overlay" id="admModal">
  <div class="modal-box">
    <div class="modal-hdr">
      <h2>‚öôÔ∏è Administration</h2>
      <button class="modal-close-btn" onclick="closeAdmin()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="pw-wrap" id="pwWrap">
        <p>üîí Entrez le mot de passe administrateur</p>
        <input type="password" class="pw-input" id="pwInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeyup="if(event.key==='Enter')checkPw()">
        <br><button class="pw-go" onclick="checkPw()">Acc√©der</button>
        <div class="pw-err" id="pwErr">‚ùå Mot de passe incorrect</div>
      </div>
      <div class="adm-wrap" id="admWrap">
        <div class="adm-tabs">
          <button class="adm-tab-btn on" onclick="admSwitch('chalets',this)">üè† Chalets</button>
          <button class="adm-tab-btn" onclick="admSwitch('sectors',this)">üìç Secteurs</button>
        </div>
        <div class="adm-pane on" id="admp-chalets">
          <label class="adm-lbl">Secteur</label>
          <select class="adm-sel" id="admSelSec" onchange="admRenderChalets()"></select>
          <label class="adm-lbl">Nom du nouveau chalet</label>
          <input type="text" class="adm-inp" id="admNewChalet" placeholder="Ex: Le Refuge des Pins...">
          <button class="adm-add" onclick="admAddChalet()">+ Ajouter ce chalet</button>
          <hr class="adm-hr">
          <div class="adm-sub">Chalets dans ce secteur</div>
          <div id="admChaletList"></div>
        </div>
        <div class="adm-pane" id="admp-sectors">
          <label class="adm-lbl">Nom du nouveau secteur</label>
          <div class="emote-row">
            <input type="text" class="adm-inp" id="admNewSec" placeholder="Ex: St-Michel-des-Saints...">
            <div class="emote-box" id="emotePrev" onclick="toggleEmojiPicker()">üè°</div>
          </div>
          <div class="emoji-picker" id="emojiPicker"></div>
          <button class="adm-add" onclick="admAddSector()">+ Ajouter ce secteur</button>
          <hr class="adm-hr">
          <div class="adm-sub">Secteurs existants</div>
          <div id="admSecList"></div>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/app-addc/sw.js')
        .then(reg => console.log('‚úÖ SW enregistr√©:', reg.scope))
        .catch(err => console.error('‚ùå SW erreur:', err));
    });
  }
</script>
</body>
</html>
